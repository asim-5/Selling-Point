<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Customer</title>

    <!-- Bootstrap CSS v5.3.2 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous"
    />
    <style>
        /* Styling for form container */
        .form-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-family: Arial, sans-serif;
        }

        /* Form title */
        .form-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Labels for form fields */
        label {
            font-size: 16px;
            color: #333;
            display: block;
            margin-top: 10px;
        }

        /* Input styling */
        input[type="text"],
        input[type="email"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        /* Button styling */
        .form-button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
        }

        /* Button hover effect */
        .form-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="allcos.html">ALL CUSTOMER</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="indexx.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="vender.html">Vendor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="stock.html">Stock</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="vendorAdd.html">Add Supply</a>
                    </li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>
</header>
<body>
    <div class="form-container">
        <h1 class="form-title">Edit Customer</h1>
        <form id="editCustomerForm">
            <label for="customerName">Customer Name</label>
            <input type="text" id="customerName" name="name" required>

            <label for="customerEmail">Email</label>
            <input type="email" id="customerEmail" name="email" required>

            <label for="customerPhone">Phone</label>
            <input type="text" id="customerPhone" name="phone" required>

            <label for="customerAddress">Address</label>
            <input type="text" id="customerAddress" name="address" required>

            <label for="customerDebt">Total Debt</label>
            <input type="number" id="customerDebt" name="debt" required>

            <button type="button" class="form-button" onclick="updateCustomer()">Update Customer</button>
            <div style="height: 15px;"></div>
            <!-- <button type="button" class="form-button" onclick="DeleteCustomer()">Delete Customer</button> -->
        </form>
    </div>

    <script>
        const token = localStorage.getItem('token'); 
        if (!token) {
            window.location.href = 'login.html';
        }

        function getUserIdFromToken() {
            if (!token) {
                console.error('No token found in local storage');
                return null;
            }

            try {
                const payload = token.split('.')[1];
                const decodedPayload = JSON.parse(atob(payload));
                return decodedPayload.userId;
            } catch (error) {
                console.error('Invalid token format', error);
                return null;
            }
        }

        const userId = getUserIdFromToken();
        
        // Function to get query parameters
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Retrieve customer ID from the query parameters
        const customerId = getQueryParam('id');

        // Function to fetch customer data
        async function fetchCustomerData() {
            try {
                const apiUrl = `http://localhost:5000/api/v1/customer/getall/${userId}`;
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.success) {
                    const customer = data.data.find(customer => customer.customer_id == customerId);
                    
                    if (customer) {
                        document.getElementById('customerName').value = customer.name;
                        document.getElementById('customerEmail').value = customer.email;
                        document.getElementById('customerPhone').value = customer.phone;
                        document.getElementById('customerAddress').value = customer.address;
                        document.getElementById('customerDebt').value = customer.total_debt;
                    } else {
                        alert("Customer not found.");
                    }
                } else {
                    console.error(data.message);
                }
            } catch (error) {
                console.error("Error fetching customer data:", error);
            }
        }

        // Fetch customer data when the page loads
        window.onload = fetchCustomerData;

        // Function to update customer data
        async function updateCustomer() {
            const currentDate = new Date();
            const formattedDate = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')} ${String(currentDate.getHours()).padStart(2, '0')}:${String(currentDate.getMinutes()).padStart(2, '0')}:${String(currentDate.getSeconds()).padStart(2, '0')}`;

            const customerData = {
                customer_id: customerId,
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                total_debt: document.getElementById('customerDebt').value,
                last_update: formattedDate // Format as YYYY-MM-DD HH:MM:SS
            };

            try {
                const response = await fetch(`http://localhost:5000/api/v1/customer/UpdateCustomer/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    alert("Customer updated successfully!");
                } else {
                    alert("Failed to update customer.");
                }
                window.location.href = 'allcos.html';
            } catch (error) {
                console.error("Error updating customer:", error);
            }
        }
        async function DeleteCustomer(){
            const confirmDelete = confirm("Are you sure you want to remove this record?");
    
            if (!confirmDelete) {
                // Exit the function if the user cancels
                return;
            }
            try {
                // Send DELETE request to the server
                const response = await fetch(`http://localhost:5000/api/v1/customer/delete/${customerId}`, {
                    method: 'DELETE'
                });

                // Handle response
                if (response.ok) {
                    alert('Customer deleted successfully!');
                    // Optionally, redirect or refresh the page after deletion
                    // window.location.reload(); // Uncomment to refresh the page
                } else {
                    const data = await response.json();
                    alert(`Failed to delete customer: ${data.message || "Unknown error"}`);
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('An error occurred while trying to delete the customer.');
            }
            window.location.href = 'allcos.html';
        }
            
        
    </script>
</body>
</html>
