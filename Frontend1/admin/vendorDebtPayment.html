<!DOCTYPE html>
<html lang="en">
<head>
    <title>ALL CUSTOMER</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS v5.2.1 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous"
    />
 <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .buttons {
            display: flex;
            gap: 5px;
        }
        .btn {
            padding: 5px 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            color: white;
        }
        .btn-edit {
            margin-top: 20px;
            display: block;
            width: 100px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-left: auto;
            margin-right: auto;
        }
        .btn-edit:hover {
            background-color: #45a049;
        }
        .btn-print {
            margin-top: 20px;
            display: block;
            width: 100px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-left: auto;
            margin-right: auto;
        }
        .btn-print:hover {
            background-color: #45a049;
        }
        .btn-detail {
            background-color: #007bff;
        }
    </style>
</head>
<body>
<!-- place navbar here -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="allcos.html">ALL CUSTOMER</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="indexx.html">Dashboard</a>
          </li>
          <li class="nav-item"></li>
          <a class="nav-link" href="vender.html">vender</a>
        </li>
        <li class="nav-item"></li>
          <a class="nav-link" href="stock.html">stock</a>
        </li>
        </ul>
        <form class="d-flex">
          <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
          <button class="btn btn-outline-success" type="submit">Search</button>
        </form>
      </div>
    </div>
  </nav>
</header>
    <h2>Vendor Data</h2>

    <div>
        <p style="font-weight: bold; font-size: 16px; color: #333; display: flex; align-items: center; gap: 5px; ">
            Last Updated: <span id="last_update" style="font-weight: normal; color: #007bff;"></span>
        </p>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>id</th>
                    <th>Phone Number</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Amount due</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="customer-info">
                <!-- Customer info will be populated here -->
            </tbody>
        </table>
        <!-- <button id="insert-bill-btn">INSERT</button> -->
    </div>

    <div>
        <table>
            <thead>
                <tr>
                    <th>id</th>
                    <th>Payment date</th>
                    <th>Total Amount</th>
                    <th>Payment Description</th>
                    <th>Remove</th>
                    <th>Print</th>
                    
                </tr>
            </thead>
            <tbody id="loan-info">
                <!-- Loan data will be populated here -->
            </tbody>
        </table>
    </div>
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Enter Payment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="paymentAmount" class="form-label">Payment Amount</label>
                    <input type="number" class="form-control" id="paymentAmount" placeholder="Enter amount">
    
                    <label for="paymentOption" class="form-label mt-3">Payment Option</label>
                    <select class="form-select" id="paymentOption" onchange="handlePaymentOptionChange()" >
                        <option value="cash">Cash</option>
                        <option value="cheque">Cheque</option>
                        <option value="exchange"style="line-height: 100;">Exchange</option>
                    </select>
    
                    <!-- Dynamic input for cheque or exchange -->
                    <div id="paymentOptionDetails" class="mt-3" style="display: none;">
                        <label for="paymentOptionInput" class="form-label" id="paymentOptionLabel"></label>
                        <input type="text" class="form-control" id="paymentOptionInput" placeholder="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitPayment()">Submit Payment</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

    <script>
  const token = localStorage.getItem('token'); 
if(!token){
    window.location.href = 'login.html';
}

function getUserIdFromToken() {
    if (!token) {
        console.error('No token found in local storage');
        return null;
    }

    try {
        const payload = token.split('.')[1];
        const decodedPayload = JSON.parse(atob(payload));
        return decodedPayload.userId;
    } catch (error) {
        console.error('Invalid token format', error);
        return null;
    }
}

let customers = [];

async function getCustomersList(userId) {
            try {
                // Define the API endpoint
                const apiUrl = `http://localhost:5000/api/v1/vendor/getVendors/${userId}`;

                // Make the GET request to fetch customer data
                const response = await fetch(apiUrl);
                const data = await response.json();

                // Check if the request was successful
                if (data.success) {
                    // Populate the global customer list with the fetched data
                    customers = data.data.map(customer => {
                        return {
                            id: customer.vendor_id,
                            name: customer.name,
                            email: customer.email,
                            phone: customer.phone,
                            address: customer.location,
                            debt: customer.total_debt,
                            update: customer.last_update
                        };
                    });

                    console.log("Customer List:", customers);
                    renderCustomerDetails(); // Call renderCustomers after data is fetched
                } else {
                    console.error(data.message);
                    customers = []; // Reset to an empty list if no data
                }
            } catch (error) {
                console.error("Error fetching customer data:", error);
                customers = []; // Reset to an empty list in case of error
            }
        }

document.addEventListener('DOMContentLoaded', () => {
    const userId = getUserIdFromToken();
    if (userId) getCustomersList(userId);
});

// Function to get query parameters
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}
const customerId = getQueryParam('id');
// Function to render customer details
function renderCustomerDetails() {
    
    const customer = customers.find(cust => cust.id == customerId);

    if (customer) {
        const detailsDiv = document.getElementById('customer-info');
        detailsDiv.innerHTML = `
            <td> ${customer.name}</td>
            <td>${customer.id}</td>
            <td>${customer.phone}</td>
            <td>${customer.email}</td>
            <td>${customer.address}</td>
            <td>${customer.debt}</td>
            <td>
            <button 
                class="btn btn-edit" 
                id="insert" 
                style="padding: 10px 20px; min-width: 150px;" 
                data-bs-toggle="modal" 
                data-bs-target="#paymentModal">
                Make Payment
            </button>
            </td>
        `;

        const update = document.getElementById("last_update");
        const formattedDate = new Date(customer.update).toLocaleDateString();
        update.textContent = formattedDate;
    } else {
        console.error("Customer not found.");
    }
}

// let debtProducts = [];

async function fetchDebtRecords(userId, customerId) {
    try {
        const apiUrl = `http://localhost:5000/api/v1/vendor/debtVendor/${customerId}/${userId}`;
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
        });
        const data = await response.json();

        if (data.success) {
            const debtRecords = data.data.map(record => ({
                debtId: record.payment_id,
                customerId: record.vendor_id,
                paymentDate: new Date(record.payment_date).toLocaleDateString(),
                amount: record.payment_amount,
                paymentDescription:record.payment_option
            }));
            renderDebtRecords(debtRecords);
        } else {
            console.error(data.message);
        }
    } catch (error) {
        console.error("Error fetching debt records:", error);
    }
}

function renderDebtRecords(debtRecords) {
    const loanInfo = document.getElementById("loan-info");
    loanInfo.innerHTML = ''; // Clear before rendering
    debtRecords.forEach(record => {
       
        loanInfo.innerHTML += `
            <tr>
                <td>${record.debtId}</td>
                <td>${record.paymentDate}</td>
                <td>${record.amount}</td>
                <td>${record.paymentDescription}</td>
                <td><button class="btn-print" onclick="Remove(${record.debtId})">Remove</button></td>
                <td><button class="btn-print" onclick="printPage()">Print</button></td>
            </tr>
        `;
 
        console.log(loanInfo);
    });
}
const userId = getUserIdFromToken(); 
document.addEventListener('DOMContentLoaded', () => {
    
    const customerId = getQueryParam('id'); 
    console.log(customerId);
    if (userId && customerId) fetchDebtRecords(userId, customerId);
});

function printPage() {
    window.print();
}
async function Remove(debtId) {
    console.log(debtId,customerId);
    const confirmDelete = confirm("Are you sure you want to remove this debt record?");
    
    if (!confirmDelete) {
        // Exit the function if the user cancels
        return;
    }
    const apiUrl = `http://localhost:5000/api/v1/vendor/vendorDebtRemove/${customerId}/${debtId}/${userId}`;

    try {
        const response = await fetch(apiUrl, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            console.log('Debt record successfully removed.');
            // Optionally, refresh the list of debt records here
            fetchDebtRecords(userId, customerId);
            getCustomersList(userId);
        } else {
            console.error('Error:', data.message);
        }
    } catch (error) {
        console.error('Error while trying to delete debt record:', error);
    }
}
function handlePaymentOptionChange() {
    const paymentOption = document.getElementById('paymentOption').value;
    const paymentOptionDetails = document.getElementById('paymentOptionDetails');
    const paymentOptionLabel = document.getElementById('paymentOptionLabel');
    const paymentOptionInput = document.getElementById('paymentOptionInput');

    if (paymentOption === 'cheque') {
        paymentOptionDetails.style.display = 'block';
        paymentOptionLabel.textContent = 'Enter Cheque Number';
        paymentOptionInput.placeholder = 'Cheque Number';
    } else if (paymentOption === 'exchange') {
        paymentOptionDetails.style.display = 'block';
        paymentOptionLabel.textContent = 'Enter Exchange Details';
        paymentOptionInput.placeholder = 'Exchange Details';
    } else {
        paymentOptionDetails.style.display = 'none';
        paymentOptionLabel.textContent = '';
        paymentOptionInput.value = '';
    }
}

// Submit payment with selected options
async function submitPayment() {
    const userId = getUserIdFromToken();

    const paymentamount = document.getElementById('paymentAmount').value;
    const paymentOption = document.getElementById('paymentOption').value;
    const paymentOptionInput = document.getElementById('paymentOptionInput').value;

    let paymentDescription = '';

    if (paymentOption === 'cash') {
        paymentDescription = 'cash';
    } else if (paymentOption === 'cheque') {
        if (!paymentOptionInput) {
            alert('Please enter a cheque number.');
            return;
        }
        paymentDescription = `Cheque: ${paymentOptionInput}`;
    } else if (paymentOption === 'exchange') {
        if (!paymentOptionInput) {
            alert('Please enter exchange details.');
            return;
        }
        paymentDescription = `Exchange: ${paymentOptionInput}`;
    }

    if (!paymentAmount || paymentAmount <= 0) {
        alert('Please enter a valid payment amount.');
        return;
    }
console.log(customerId, userId, paymentAmount, paymentDescription );
    try {
        const response = await fetch('http://localhost:5000/api/v1/vendor/makeDebtPayment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ customerId, userId, paymentamount, paymentDescription })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            alert('Payment successfully submitted.');
            fetchDebtRecords(userId, customerId);
            document.getElementById('paymentAmount').value = '';
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
        } else {
            alert(data.message || 'Failed to submit payment.');
        }
    } catch (error) {
        console.error('Error submitting payment:', error);
        alert('An error occurred while submitting the payment.');
    }

    fetchDebtRecords(userId, customerId);
    getCustomersList(userId);
}


    </script>
</body>
</html>
