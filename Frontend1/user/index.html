<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.3.2 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    
    <title>POS Dashboard</title>
    <link rel="stylesheet" href="index.css">
    <style>
        .logout-btn {
            padding: 7.5px 15px;
            background-color: #dc3545;
            color: white;
            font-size: 13px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 7px;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>

<body>
    <header>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link active" href="allcos.html">ALL CUSTOMER</a></li>
                        <li class="nav-item"><a class="nav-link" href="customer.html">NEW CUSTOMER</a></li>
                        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="vender.html">Vender</a></li>
                        <li class="nav-item"><a class="nav-link" href="stock.html">Stock</a></li>
                    </ul>
                    <!-- Admin Button -->
                    <button id="admin-btn" class="btn btn-outline-danger">Admin</button>
                    <!-- logout button -->
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <!-- Current Sale Section -->
        <div class="current-sale">
            <h3>Current Sale</h3>
            <ul id="sale-items"></ul>
            <p>Sub-total: <span id="sub-total">$0.00</span></p>
            <p>Tax (NZ GST): <span id="tax">$0.00</span></p>
            <p><b>TOTAL: <span id="total">$0.00</span></b></p>
            <!-- Customer ID Input -->
            <div class="customer-id">
                <label for="customer-id-input">Customer ID:</label>
                <input type="text" id="customer-id-input" placeholder="Enter Customer ID">
            </div>
            <!-- Save Receipt Button -->
            <button id="save-receipt-button">Save & Print Receipt</button>
        </div>

        <!-- Categories Section -->
        <div class="categories">
            <h3>Categories</h3>
            <div class="search-bar">
                <input type="text" id="product-search" placeholder="Search product...">
            </div>
            <div id="categoryButtons" class="category-buttons"></div>
        </div>

        <!-- Products Section -->
        <div class="products">
            <h3>Products</h3>
            <div id="product-list"></div>
        </div>
    </div>

    <script>
        const categories = {};
        const billItems = [];
        let currentCustomer = { id: "0", name: "Customer Zero" };
        let currentSale = [];
        const taxRate = 0.15;
        const token = localStorage.getItem('token'); 
        if(!token){
            window.location.href = 'login.html';
        }
    
        function getUserIdFromToken() {
            // Retrieve the token from local storage
            if (!token) {
                console.error('No token found in local storage');
                return null;
            }
    
            // Decode the token
            const payload = token.split('.')[1];
            const decodedPayload = JSON.parse(atob(payload));
    
            // Extract the user ID (assuming it's stored under 'userId' in the payload)
            const userId = decodedPayload.userId;
    
            return userId;
        }
    
        // Function to load categories and products
        async function loadCategories(userId) {
            try {
                // Fetch the categories
                const response = await fetch(`http://localhost:5000/api/v1/product/categories/${userId}`);
                const data = await response.json();
    
                if (data.success) {
                    // Clear previous categories
                    Object.keys(categories).forEach(key => delete categories[key]);
    
                    // Populate category buttons
                    const categoryButtonsContainer = document.getElementById('categoryButtons');
                    categoryButtonsContainer.innerHTML = '';
    
                    // Fetch products by category
                    for (const category of data.data) {
                        const categoryName = category.category;
                        const encodedCategoryName = encodeURIComponent(categoryName);
    
                        // Fetch products for each category
                        const productsResponse = await fetch(`http://localhost:5000/api/v1/product/ProductByCategory/${userId}?categoryName=${encodedCategoryName}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
    
                        const productsData = await productsResponse.json();
    
                        if (productsData.success) {
                            categories[categoryName] = productsData.data.map(product => ({
                                name: product.name,
                                price: product.price,
                                category: categoryName
                            }));
    
                            // Add category button
                            const button = document.createElement('button');
                            button.className = 'category-btn';
                            button.textContent = categoryName;
                            button.onclick = () => displayProducts(categoryName);
                            categoryButtonsContainer.appendChild(button);
                        } else {
                            console.error(`No products found for category: ${categoryName}`);
                        }
                    }
    
                    // Optionally, display the default or first category
                    if (data.data.length > 0) {
                        displayProducts(data.data[0].category);
                    }
                } else {
                    console.error('No categories found');
                }
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }
    
        // Function to display products for the selected category
        function displayProducts(categoryName) {
            const products = categories[categoryName]; // Get products for the selected category
    
            // Check if there are products for the selected category
            if (!products || products.length === 0) {
                console.error(`No products found for category: ${categoryName}`);
                return;
            }
    
            // Render products in the product-list div
            const productList = document.getElementById('product-list');
            productList.innerHTML = ''; // Clear previous products
    
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.classList.add('product-item');
                productDiv.innerHTML = `
                    <span>${product.name}</span>
                    <button class="product-button" data-name="${product.name}" data-price="${product.price}">Add</button>
                `;
                productList.appendChild(productDiv);
            });
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            const productList = document.getElementById('product-list');
            const saleItems = document.getElementById('sale-items');
            const subTotalEl = document.getElementById('sub-total');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');
            const searchInput = document.getElementById('product-search');
            const categoryButtonsContainer = document.getElementById('categoryButtons');
            const customerIdInput = document.getElementById('customer-id-input');
            const saveReceiptButton = document.getElementById('save-receipt-button');
    
            // Filter products by category and search term
            function filterProducts(category, searchTerm = '') {
                const filteredProducts = Object.entries(categories)
                    .flatMap(([cat, products]) =>
                        products.filter(p => (category === 'all' || p.category === category) &&
                            p.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                renderProducts(filteredProducts);
            }
    
            // Event listeners for category buttons
            categoryButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn')) {
                    const category = e.target.textContent;
                    const searchTerm = searchInput.value;
                    filterProducts(category, searchTerm);
                }
            });
    
            // Search functionality with category filtering
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                const selectedCategory = document.querySelector('.category-buttons .category-btn.active')?.textContent || 'all';
                filterProducts(selectedCategory, searchTerm);
            });
    
            // Render products dynamically
            function renderProducts(productArray) {
                productList.innerHTML = '';
                productArray.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('product-item');
                    productDiv.innerHTML = `
                        <span>${product.name}</span>
                        <button class="product-button" data-name="${product.name}" data-price="${product.price}">Add</button>
                    `;
                    productList.appendChild(productDiv);
                });
            }
    
            // Add product to sale with quantity control
            productList.addEventListener('click', (e) => {
                if (e.target.classList.contains('product-button')) {
                    const productName = e.target.getAttribute('data-name');
                    const productPrice = parseFloat(e.target.getAttribute('data-price'));
                    const product = { name: productName, price: productPrice };
                    addToSale(product);
                }
            });
    
            // Function to add product to the current sale
            function addToSale(product) {
                const existingItem = currentSale.find(item => item.name === product.name);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    currentSale.push({ ...product, quantity: 1 });
                }
                updateSaleUI();
            }
    
            // Function to update the sale UI and calculate totals
            function updateSaleUI() {
                saleItems.innerHTML = '';
                let subTotal = 0;
    
                currentSale.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${item.name} - $${item.price.toFixed(2)} x ${item.quantity}`;
                    
                    // Create a button to decrease quantity
                    const decreaseButton = document.createElement('button');
                    decreaseButton.textContent = '-';
                    decreaseButton.onclick = () => decreaseQuantity(item);
                    
                    // Append button to list item
                    listItem.appendChild(decreaseButton);
                    saleItems.appendChild(listItem);
                    
                    subTotal += item.price * item.quantity;
                });
    
                subTotalEl.textContent = `$${subTotal.toFixed(2)}`;
                const tax = subTotal * taxRate;
                taxEl.textContent = `$${tax.toFixed(2)}`;
                totalEl.textContent = `$${(subTotal + tax).toFixed(2)}`;
            }
    
            // Function to decrease quantity
            function decreaseQuantity(item) {
                const existingItem = currentSale.find(i => i.name === item.name);
                if (existingItem.quantity > 1) {
                    existingItem.quantity--;
                } else {
                    // If quantity is 1, remove the item
                    currentSale = currentSale.filter(i => i.name !== item.name);
                }
                updateSaleUI();
            }
    
            // Save and print receipt functionality
            saveReceiptButton.addEventListener('click', () => {
                const receiptData = {
                    customerId: customerIdInput.value,
                    items: currentSale,
                    total: totalEl.textContent,
                };
                console.log('Receipt Data:', receiptData);
                alert('Receipt saved successfully!');
            });
    
            // Load categories for user id
            loadCategories(getUserIdFromToken());
    
        });
    
        function logout() {
            // Implement logout functionality
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
        document.getElementById('admin-btn').addEventListener('click', function () {
    // Prompt for password
    const password = prompt("Enter admin password:");

    // Check if the password is correct
    if (password === "admin123") {  // Replace with your desired password
      window.location.href = "../admin/indexx.html";  // Redirect to admin page
    } else {
      alert("Incorrect password.");
    }
  });
    </script>
    
    

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz4fnFO9gybktF+z6kbuTqVDn0mgF1vj4irZyw+PQ5mHkA1Utbm24D+R1e" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-oBqDVmMz4fnFO9gybktF+z6kbuTqVDn0mgF1vj4irZyw+PQ5mHkA1Utbm24D+R1e" crossorigin="anonymous"></script>
</body>
</html>
