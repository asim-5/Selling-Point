<!DOCTYPE html>
<html lang="en">
<head>
    <title>ALL CUSTOMER</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS v5.2.1 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous"
    />
 <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .buttons {
            display: flex;
            gap: 5px;
        }
        .btn {
            padding: 5px 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            color: white;
        }
        .btn-edit {
            margin-top: 20px;
            display: block;
            width: 100px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-left: auto;
            margin-right: auto;
        }
        .btn-edit:hover {
            background-color: #45a049;
        }
        .btn-print {
            margin-top: 20px;
            display: block;
            width: 100px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-left: auto;
            margin-right: auto;
        }
        .btn-print:hover {
            background-color: #45a049;
        }
        .btn-detail {
            background-color: #007bff;
        }
    </style>
</head>
<body>
<!-- place navbar here -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="allcos.html">ALL CUSTOMER</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="index.html">Dashboard</a>
          </li>
          <li class="nav-item"></li>
          <a class="nav-link" href="vender.html">vender</a>
        </li>
        <li class="nav-item"></li>
          <a class="nav-link" href="stock.html">stock</a>
        </li>
        <li class="nav-item"></li>
        <a class="nav-link" href="vendorAdd.html">Add Supply</a>
    </li>
        </ul>
        <form class="d-flex">
          <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
          <button class="btn btn-outline-success" type="submit">Search</button>
        </form>
      </div>
    </div>
  </nav>
</header>
    <h2>Customer Data</h2>

    <div>
        <p style="font-weight: bold; font-size: 16px; color: #333; display: flex; align-items: center; gap: 5px; ">
            Last Updated: <span id="last_update" style="font-weight: normal; color: #007bff;"></span>
        </p>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>id</th>
                    <th>Phone Number</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Amount due</th>
                </tr>
            </thead>
            <tbody id="customer-info">
                <!-- Customer info will be populated here -->
            </tbody>
        </table>
        <!-- <button id="insert-bill-btn">INSERT</button> -->
    </div>

    <div>
        <table>
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Purchase date</th>
                    <th>quantity</th>
                    <th>Total Amount</th>
                    <th>Payment Desription</th>
                    <th>Discount</th>
                    <th>print</th>
                    
                </tr>
            </thead>
            <tbody id="loan-info">
                <!-- Loan data will be populated here -->
            </tbody>
        </table>
    </div>

    <script>
    const token = localStorage.getItem('token'); 
        if(!token){
            window.location.href = 'login.html';
        }
        function getUserIdFromToken() {
            // Retrieve the token from local storage
            if (!token) {
                console.error('No token found in local storage');
                return null;
            }
    
            // Decode the token
            const payload = token.split('.')[1];
            const decodedPayload = JSON.parse(atob(payload));
    
            // Extract the user ID (assuming it's stored under 'userId' in the payload)
            const userId = decodedPayload.userId;
    
            return userId;
        }

let customers = [];

        async function getCustomersList(userId) {
            try {
                // Define the API endpoint
                const apiUrl = `http://localhost:5000/api/v1/vendor/getVendors/${userId}`;

                // Make the GET request to fetch customer data
                const response = await fetch(apiUrl);
                const data = await response.json();

                // Check if the request was successful
                if (data.success) {
                    // Populate the global customer list with the fetched data
                    customers = data.data.map(customer => {
                        return {
                            id: customer.vendor_id,
                            name: customer.name,
                            email: customer.email,
                            phone: customer.phone,
                            address: customer.location,
                            debt: customer.total_debt,
                            update: customer.last_update
                        };
                    });

                    console.log("Customer List:", customers);
                    renderCustomerDetails(); // Call renderCustomers after data is fetched
                } else {
                    console.error(data.message);
                    customers = []; // Reset to an empty list if no data
                }
            } catch (error) {
                console.error("Error fetching customer data:", error);
                customers = []; // Reset to an empty list in case of error
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const userId = getUserIdFromToken();
            getCustomersList(userId);
        });

// Function to get query parameters
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// Function to render customer details
function renderCustomerDetails() {
    const customerId = getQueryParam('id');
    const customer = customers.find(cust => cust.id == customerId);

    if (customer) {
        const detailsDiv = document.getElementById('customer-info');
        detailsDiv.innerHTML = `
            <td> ${customer.name}</td>
            <td>${customer.id}</td>
            <td>${customer.phone}</td>
            <td>${customer.email}</td>
            <td>${customer.address}</td>
            <td>${customer.debt}</td>
        `;

        const update=document.getElementById("last_update");
        const formattedDate = new Date(customer.update).toLocaleDateString();
        update.innerHTML=`
        <p style="    margin-bottom: 0;">${formattedDate}</p>
        `;
    } else {
        document.getElementById('customerDetails').innerHTML = '<p>Customer not found.</p>';
    }
}
        // Populate customer info
    //     const customerInfo = document.getElementById("customer-info");
    //     customerInfo.innerHTML = `
    //         <tr>
    //             <td>${customerData.name}</td>
    //             <td>${customerData.id}</td>
    //             <td>${customerData.phoneNumber}</td>
    //             <td>${customerData.totalLoan}</td>
    //             <td><button class="btn btn-edit" id='insert'>INSERT</button></td>
                
    //         </tr>
    //     `;
    //     document.getElementById('insert').addEventListener('click', function() {
    //     window.location.href = 'insert.html';
    // });

    let debtProducts = [];

    async function fetchDebtProducts(userId, customerId) {
        try {
            const apiUrl = `http://localhost:5000/api/v1/vendor/supply_history/${userId}/${customerId}`;
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                debtProducts = data.data.map(product => ({
                    purchaseId: product.purchase_id,
                    productId: product.product_id,
                    name: product.name,
                    purchaseDate: new Date(product.purchase_date).toLocaleDateString(),
                    quantity: product.quantity,
                    totalPrice: product.total_price,
                    payment_status: product.payment_status,
                    payment_option:product.payment_option,
                    discount:product.discount
                }));
                renderDebtProducts();
            } else {
                console.error(data.message);
                debtProducts = [];
            }
        } catch (error) {
            console.error("Error fetching debt products:", error);
            debtProducts = [];
        }
    }

    function renderDebtProducts() {
        const loanInfo = document.getElementById("loan-info");
        loanInfo.innerHTML = ''; // Clear before rendering
        debtProducts.forEach(product => {
            loanInfo.innerHTML += `
                <tr>
                    <td>${product.name}</td>
                    <td>${product.purchaseDate}</td>
                    <td>${product.quantity}</td>
                    <td>${product.totalPrice}</td>
                    <td>${product.payment_option}</td>
                    <td>${product.discount}</td>
                    <td><button class="btn-print" onclick="printPage()">Print</button></td>
                </tr>
            `;
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const userId = getUserIdFromToken(); 
        const customerId = getQueryParam('id'); 
        console.log(customerId);
        fetchDebtProducts(userId, customerId);
    });

        // Populate loan data
      
    

    // Function to print the page
    function printPage() {
            window.print();
        }


    </script>
</body>
</html>
