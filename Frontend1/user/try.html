<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS UI with Quantity Input</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }

    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
      flex-wrap: wrap;
    }

    .current-sale, .categories, .products {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 300px;
    }

    h3 {
      color: #333;
      margin-bottom: 15px;
    }

    .vendor-id label, .vendor-id input {
      display: block;
      margin-bottom: 10px;
    }

    .vendor-id input, .search-bar input, select, .quantity-section input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    #categoryButtons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .category-buttons button {
      padding: 8px 12px;
      background-color: #f8f9fa;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .category-buttons button:hover {
      transform: scale(1.05);
    }

    #sale-items {
      list-style: none;
      padding: 0;
    }

    #sale-items li {
      margin-bottom: 10px;
    }

    .products #product-list {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .products #product-list .product-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 120px;
    }

    .products #product-list .product-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .quantity-section {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 15px;
    }

    .quantity-section input {
      width: 60px;
      text-align: center;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Current Sale Section -->
    <div class="current-sale">
      <h3>Current Sale</h3>
      <ul id="sale-items"></ul>
      <p>Sub-total: <span id="sub-total">$0.00</span></p>
      <p>Tax (NZ GST): <span id="tax">$0.00</span></p>
      <p><b>TOTAL: <span id="total">$0.00</span></b></p>

      <div class="vendor-id">
        <label for="vendor-id-input">Customer ID:</label>
        <button id="open-modal-btn"><i class="fas fa-user"></i> Select Customer</button>
        <input type="text" id="vendor-id-input" placeholder="Customer ID">
      </div>

      <select id="signal" name="signal">
        <option value="1">Pay</option>
        <option value="0">Debt</option>
      </select>
      <button id="save-receipt-button"><i class="fas fa-save"></i> Save & Print Receipt</button>
    </div>

    <!-- Products Section -->
    <div class="products">
      <h3>Products</h3>
      <div id="product-list">
        <!-- Example Product -->
        <div class="product-card" data-product-id="1">
          <p>Product 1</p>
          <div class="quantity-section">
            <input type="number" class="product-quantity" value="1" min="1">
            <button class="add-product-btn" onclick="increaseQuantity(this)">+</button>
            <button class="add-product-btn" onclick="decreaseQuantity(this)">-</button>
          </div>
          <button class="add-to-sale-btn" onclick="addToSale(this)">Add to Sale</button>
        </div>
        <div class="product-card" data-product-id="2">
          <p>Product 2</p>
          <div class="quantity-section">
            <input type="number" class="product-quantity" value="1" min="1">
            <button class="add-product-btn" onclick="increaseQuantity(this)">+</button>
            <button class="add-product-btn" onclick="decreaseQuantity(this)">-</button>
          </div>
          <button class="add-to-sale-btn" onclick="addToSale(this)">Add to Sale</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function increaseQuantity(button) {
      const inputField = button.parentElement.querySelector('.product-quantity');
      inputField.value = parseInt(inputField.value) + 1;
    }

    function decreaseQuantity(button) {
      const inputField = button.parentElement.querySelector('.product-quantity');
      if (inputField.value > 1) {
        inputField.value = parseInt(inputField.value) - 1;
      }
    }

    function addToSale(button) {
      const productCard = button.parentElement;
      const productId = productCard.getAttribute('data-product-id');
      const quantity = productCard.querySelector('.product-quantity').value;
      
      if (quantity && quantity > 0) {
        // Add product to the sale list dynamically
        const saleItemsList = document.getElementById('sale-items');
        const newItem = document.createElement('li');
        newItem.textContent = `Product ${productId} (x${quantity})`;
        saleItemsList.appendChild(newItem);

        // Update subtotal, tax, and total (basic example)
        let subtotal = parseFloat(document.getElementById('sub-total').textContent.replace('$', '')) || 0;
        subtotal += quantity * 10; // Assuming each product is $10
        document.getElementById('sub-total').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('total').textContent = `$${(subtotal * 1.15).toFixed(2)}`; // Adding 15% tax

        alert(`Added Product ${productId} (x${quantity}) to sale!`);
      } else {
        alert('Please enter a valid quantity.');
      }
    }
  </script>
</body>
</html>



<script>
    // Function to print the page
    function printPage() {
const container = document.getElementById("print");
if (!container) {
    console.error("Error: 'container' not found.");
    return;
}

console.log("Container HTML for print:", container.innerHTML); // Debugging

const originalContent = document.body.innerHTML; // Save original content
document.body.innerHTML = container.innerHTML; // Replace body content

// Trigger print dialog
window.print();

// Restore content after the print dialog completes
document.body.innerHTML = originalContent;
}

//print end
    const categories = {};
    const billItems = [];
    let currentCustomer = { id: "0", name: "Customer Zero" };
    let currentSale = [];
    const taxRate = 0.15;
    const token = localStorage.getItem('token'); 
    if(!token){
        window.location.href = 'login.html';
    }
    let uid;
    function getUserIdFromToken() {
        // Retrieve the token from local storage
        if (!token) {
            console.error('No token found in local storage');
            return null;
        }

        // Decode the token
        const payload = token.split('.')[1];
        const decodedPayload = JSON.parse(atob(payload));

        // Extract the user ID (assuming it's stored under 'userId' in the payload)
        const userId = decodedPayload.userId;
        uid=userId;
        return userId;
    }

    // Function to load categories and products
    async function loadCategories(userId) {
        try {
            // Fetch the categories
            const response = await fetch(`http://localhost:5000/api/v1/product/categories/${userId}`);
            const data = await response.json();

            if (data.success) {
                // Clear previous categories
                Object.keys(categories).forEach(key => delete categories[key]);

                // Populate category buttons
                const categoryButtonsContainer = document.getElementById('categoryButtons');
                categoryButtonsContainer.innerHTML = '';

                // Fetch products by category
                for (const category of data.data) {
                    const categoryName = category.category;
                    const encodedCategoryName = encodeURIComponent(categoryName);

                    // Fetch products for each category
                    const productsResponse = await fetch(`http://localhost:5000/api/v1/product/ProductByCategory/${userId}?categoryName=${encodedCategoryName}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const productsData = await productsResponse.json();

                    if (productsData.success) {
                        categories[categoryName] = productsData.data.map(product => ({
                            productId: product.product_id,
                            name: product.name,
                            price: product.price,
                            category: categoryName
                        }));
                        // Add category button
                        // categories[categoryName].forEach(item => {
                        //     console.log('Product ID:', item.productId);
                        // });
                        const button = document.createElement('button');
                        button.className = 'category-btn';
                        button.textContent = categoryName;
                        button.onclick = () => displayProducts(categoryName);
                        categoryButtonsContainer.appendChild(button);
                    } else {
                        console.error(`No products found for category: ${categoryName}`);
                    }
                }

                // Optionally, display the default or first category
                if (data.data.length > 0) {
                    displayProducts(data.data[0].category);
                }
            } else {
                console.error('No categories found');
            }
        } catch (error) {
            console.error('Error fetching categories:', error);
        }
    }

    // Function to display products for the selected category
    function displayProducts(categoryName) {
        const products = categories[categoryName]; // Get products for the selected category

        // Check if there are products for the selected category
        if (!products || products.length === 0) {
            console.error(`No products found for category: ${categoryName}`);
            return;
        }

        // Render products in the product-list div
        const productList = document.getElementById('product-list');
        productList.innerHTML = ''; // Clear previous products

        products.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('product-item');
            productDiv.innerHTML = `
                <span>${product.name}</span>
                <button class="product-button" data-name="${product.name}" data-id="${product.productId}" data-price="${product.price}">Add</button>
            `;
            productList.appendChild(productDiv);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const productList = document.getElementById('product-list');
        const saleItems = document.getElementById('sale-items');
        const subTotalEl = document.getElementById('sub-total');
        const taxEl = document.getElementById('tax');
        const totalEl = document.getElementById('total');
        const searchInput = document.getElementById('product-search');
        const categoryButtonsContainer = document.getElementById('categoryButtons');
        const customerIdInput = document.getElementById('vendor-id-input');
        const saveReceiptButton = document.getElementById('save-receipt-button');

        // Filter products by category and search term
        function filterProducts(category, searchTerm = '') {
            const filteredProducts = Object.entries(categories)
                .flatMap(([cat, products]) =>
                    products.filter(p => (category === 'all' || p.category === category) &&
                        p.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            renderProducts(filteredProducts);
        }

        // Event listeners for category buttons
        categoryButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('category-btn')) {
                const category = e.target.textContent;
                const searchTerm = searchInput.value;
                filterProducts(category, searchTerm);
            }
        });

        // Search functionality with category filtering
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            const selectedCategory = document.querySelector('.category-buttons .category-btn.active')?.textContent || 'all';
            filterProducts(selectedCategory, searchTerm);
        });

        // Render products dynamically
        function renderProducts(productArray) {
            productList.innerHTML = '';
            productArray.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.classList.add('product-item');
                productDiv.innerHTML = `
                    <span>${product.name}</span>
                    <button class="product-button" data-name="${product.name}" data-id="${product.productId}" data-price="${product.price}">Add</button>
                `;
                productList.appendChild(productDiv);
            });
        }

        // Add product to sale with quantity control
        productList.addEventListener('click', (e) => {
            if (e.target.classList.contains('product-button')) {
                const productName = e.target.getAttribute('data-name');
                const productId=e.target.getAttribute('data-id');
               // console.log(productId);
                const productPrice = parseFloat(e.target.getAttribute('data-price'));
                const product = { name: productName,id:productId, price: productPrice };
                addToSale(product);
            }
        });

        // Function to add product to the current sale
        function addToSale(product) {
            const existingItem = currentSale.find(item => item.name === product.name);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentSale.push({ ...product, quantity: 1 });
            }
            updateSaleUI();
        }

        // Function to update the sale UI and calculate totals
        function updateSaleUI() {
            saleItems.innerHTML = '';
            let subTotal = 0;

            currentSale.forEach(item => {
                const listItem = document.createElement('li');
                listItem.textContent = `${item.name} - $${item.price.toFixed(2)} x ${item.quantity}`;
                
                // Create a button to decrease quantity
                const decreaseButton = document.createElement('button');
                decreaseButton.textContent = '-';
                decreaseButton.onclick = () => decreaseQuantity(item);
                
                // Append button to list item
                listItem.appendChild(decreaseButton);
                saleItems.appendChild(listItem);
                
                subTotal += item.price * item.quantity;
            });

            subTotalEl.textContent = `$${subTotal.toFixed(2)}`;
            const tax = subTotal * taxRate;
            taxEl.textContent = `$${tax.toFixed(2)}`;
            totalEl.textContent = `$${(subTotal + tax).toFixed(2)}`;
        }

        // Function to decrease quantity
        function decreaseQuantity(item) {
            const existingItem = currentSale.find(i => i.name === item.name);
            if (existingItem.quantity > 1) {
                existingItem.quantity--;
            } else {
                // If quantity is 1, remove the item
                currentSale = currentSale.filter(i => i.name !== item.name);
            }
            updateSaleUI();
        }
          
        const signalSelect = document.getElementById('signal');
        // Save and print receipt functionality
         saveReceiptButton.addEventListener('click', async () => {
            const receiptData = {
                customer_id: customerIdInput.value, // Assuming this is the correct customer ID field
                purchase_date: new Date().toISOString().slice(0, 19).replace('T', ' '), // Current date in the required format
                total_price: parseFloat(totalEl.textContent.replace('$', '')), // Remove the $ and convert to number
                payment_status: signalSelect.value, // Assuming this is the field for payment status
                user_id: uid, // Assuming user_id is 1 for now (this can be dynamic if needed)
                items: currentSale.map(item => ({
                    product_id: item.id, // Function to map product name to product ID
                    price: item.price,
                    quantity: item.quantity
                })),
            };

         console.log('Formatted Receipt Data:', receiptData);

            try {
                const response = await fetch('http://localhost:5000/api/v1/product/makeTransaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(receiptData),
                });

                if (!response.ok) {
                    throw new Error(`Failed to save receipt: ${response.statusText}`);
                }

                const result = await response.json();
                alert('Receipt saved successfully!');
                console.log('API Response:', result);
            } catch (error) {
                console.error('Error saving receipt:', error);
                alert('Failed to save receipt. Please try again.');
            }
            location.reload();

        });


        // Load categories for user id
        loadCategories(getUserIdFromToken());


    });
 
    function logout() {
        // Implement logout functionality
        localStorage.removeItem('token');
        window.location.href = 'login.html';
    }

document.getElementById('admin-btn').addEventListener('click', async function () 
{
// Prompt for password
        const password = prompt("Enter admin password:");
        
        // Assuming you have a way to get the user ID, set it here
        // Prepare the payload to send to the backend
        const requestBody = {
            userid: uid,
            password: password
        };

        try {
            // Send the password and userId to the backend for validation
            const response = await fetch('http://localhost:5000/api/v1/user/admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            // Check if the login was successful
            if (data.success) {
                // Redirect to admin page on success
                window.location.href = "../admin/indexx.html";
            } else {
                // Show an error message on failure
                alert(data.message || "Incorrect password.");
            }
        } catch (error) {
            console.error("Error logging in admin:", error);
            alert("An error occurred while trying to log in.");
        }
    });
    document.addEventListener("DOMContentLoaded", () => {
        const openModalBtn = document.getElementById("open-modal-btn");
        const modal = document.getElementById("vendor-modal");
        const closeModalBtn = document.querySelector(".close-btn");
        const vendorList = document.getElementById("vendor-list");
        const vendorIdInput = document.getElementById("vendor-id-input");
        // const userId = getUserIdFromToken(); // Replace with actual user ID

        // Open modal on button click
        openModalBtn.addEventListener("click", async () => {
            modal.style.display = "block";
            await fetchVendors();
        });

        // Close modal on 'X' button click
        closeModalBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });

        // Close modal when clicking outside modal content
        window.addEventListener("click", (event) => {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        });

        // Fetch vendors and populate list
        async function fetchVendors() {
            try {
                const apiUrl = `http://localhost:5000/api/v1/customer/getall/${uid}`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                console.log(data);
                if (data.success) {
                    vendorList.innerHTML = ""; // Clear previous list items
                    data.data.forEach(vendor => {
                        const listItem = document.createElement("li");
                        listItem.textContent = `${vendor.name} (ID: ${vendor.customer_id})`;
                        listItem.dataset.vendorId = vendor.customer_id;

                        // Set vendor ID on list item click
                        listItem.addEventListener("click", () => {
                            vendorIdInput.value = listItem.dataset.vendorId;
                            modal.style.display = "none"; // Close the modal
                        });

                        vendorList.appendChild(listItem);
                    });
                } else {
                    console.error(data.message);
                    vendorList.innerHTML = "<li>No vendors available.</li>";
                }
            } catch (error) {
                console.error("Error fetching vendor data:", error);
                vendorList.innerHTML = "<li>Error loading vendors.</li>";
            }
        }
    });


</script>

</body>
</html>
