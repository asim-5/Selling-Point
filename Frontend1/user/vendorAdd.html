<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.3.2 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    
    <title>POS Dashboard</title>
    <link rel="stylesheet" href="index.css">
    <style>
        .logout-btn {
            padding: 7.5px 15px;
            background-color: #dc3545;
            color: white;
            font-size: 13px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 7px;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }
        /* Modal styling */
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #f9f9f9;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
}

.close-btn {
    color: #aaa;
    float: right;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

.close-btn:hover {
    color: #000;
}

#vendor-list {
    list-style: none;
    padding: 0;
}

#vendor-list li {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
}

#vendor-list li:hover {
    background-color: #f1f1f1;
}
.modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 500px;
        padding: 20px;
        height: 700px;
        background: rgba(255, 255, 255, 0);
       

    }

    .modal-content {
        text-align: center;
    }

    .modal h3 {
        margin-bottom: 20px;
    }

    .payment-option {
        margin-bottom: 15px;
        text-align: left;
    }

    .conditional-input {
        display: none;
        margin-top: 10px;
    }

    .modal-actions {
        margin-top: 20px;
    }

    .btn {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-confirm {
        background-color: #4CAF50;
        color: white;
    }

    .btn-cancel {
        background-color: #f44336;
        color: white;
    }
    #exchangeDetails {
    resize: none; /* Prevent resizing if you want a fixed height */
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 8px;
    font-size: 14px;
    font-family: inherit;
    width: 100%;
    height: 200px;
}
    #chequeNumber{
        width: 100%;
        height: 50px;
    }
    /* Overlay Styling */
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    </style>
</head>

<body>
    <header>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link active" href="allcos.html">ALL CUSTOMER</a></li>
                        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="vender.html">Vender</a></li>
                        <li class="nav-item"><a class="nav-link" href="stock.html">Stock</a></li>
                        <li class="nav-item"></li>
                            <a class="nav-link" href="vendorAdd.html">Add Supply</a>
                        </li>
                    </ul>
                    <!-- logout button -->
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>
    </header>
    <h3 style="text-align: center;">Add Supply</h3>
    <div class="container">
        
        <!-- Current Sale Section -->
        <div class="current-sale">
            <h3>Current Sale</h3>
            <ul id="sale-items"></ul>
            <p>Sub-total: <span id="sub-total">$0.00</span></p>
            <p>Tax (NZ GST): <span id="tax">$0.00</span></p>
            <p><b>Total Discount:<span id="totalDiscountEl"> $0.00</span></b></p>
            <p><b>TOTAL: <span id="total">$0.00</span></b></p>
            <!-- Customer ID Input -->
            <div class="vendor-id">
                <label for="vendor-id-input">Vendor ID:</label>
                <button id="open-modal-btn">Select Vendor</button>
                <input type="text" id="vendor-id-input" placeholder="Vendor ID" readonly>
            </div>
            
            <!-- Modal structure -->
            <div id="vendor-modal" class="modal">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>Select Vendor</h2>
                    <ul id="vendor-list"></ul>
                </div>
            </div>
            <select id="signal" name="signal">
                <option value=1>Pay</option>
                <option value=0>Debt</option>
            </select>
            <!-- Save Receipt Button -->
            <button id="save-receipt-button" >Save & Print Receipt</button>
        </div>

        <!-- Categories Section -->
        <div class="categories">
            <h3>Categories</h3>
            <div class="search-bar">
                <input type="text" id="product-search" placeholder="Search product...">
            </div>
            <div id="categoryButtons" class="category-buttons"></div>
        </div>

        <!-- Products Section -->
        <div class="products">
            <h3>Products</h3>
            <div id="product-list"></div>
        </div>
    </div>
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="passwordModalLabel">Enter Admin Password</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="admin-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="admin-password" placeholder="Enter your password" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="confirm-password-btn">Confirm</button>
            </div>
          </div>
        </div>
      </div>
      <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3>Select Payment Option</h3>
            <form id="paymentForm">
                <div class="payment-option">
                    <label>
                        <input type="radio" name="paymentOption" value="Cash" /> Cash
                    </label>
                </div>
                <div class="payment-option">
                    <label>
                        <input type="radio" name="paymentOption" value="Cheque" /> Cheque
                    </label>
                    <div id="chequeInput" class="conditional-input">
                        <label for="chequeNumber">Cheque Number:</label>
                        <input type="text" id="chequeNumber" />
                    </div>
                </div>
                <div class="payment-option">
                    <label>
                        <input type="radio" name="paymentOption" value="Exchange" /> Exchange
                    </label>
                    <div id="exchangeInput" class="conditional-input">
                        <label for="exchangeDetails">Exchange Details:</label>
                        <textarea id="exchangeDetails" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="confirmPaymentButton" class="btn btn-confirm">Confirm</button>
                    <button type="button" id="closeModalButton" class="btn btn-cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    <div id="overlay" class="overlay"></div>
    <script>
         //print start
         function printPage() {
    const container = document.getElementById("print");
    if (!container) {
        console.error("Error: 'container' not found.");
        return;
    }

    console.log("Container HTML for print:", container.innerHTML); // Debugging

    const originalContent = document.body.innerHTML; // Save original content
    document.body.innerHTML = container.innerHTML; // Replace body content

    // Trigger print dialog
    window.print();

    // Restore content after the print dialog completes
    document.body.innerHTML = originalContent;
}
//print end
        const categories = {};
        const billItems = [];
        let currentCustomer = { id: "0", name: "Customer Zero" };
        let currentSale = [];
        const taxRate = 0.15;
        const token = localStorage.getItem('token'); 
        if(!token){
            window.location.href = 'login.html';
        }
        let uid;
        function getUserIdFromToken() {
            // Retrieve the token from local storage
            if (!token) {
                console.error('No token found in local storage');
                return null;
            }
    
            // Decode the token
            const payload = token.split('.')[1];
            const decodedPayload = JSON.parse(atob(payload));
    
            // Extract the user ID (assuming it's stored under 'userId' in the payload)
            const userId = decodedPayload.userId;
            uid=userId;
            return userId;
        }
    
        // Function to load categories and products
        async function loadCategories(userId) {
            try {
                // Fetch the categories
                const response = await fetch(`http://localhost:5000/api/v1/product/categories/${userId}`);
                const data = await response.json();
    
                if (data.success) {
                    // Clear previous categories
                    Object.keys(categories).forEach(key => delete categories[key]);
    
                    // Populate category buttons
                    const categoryButtonsContainer = document.getElementById('categoryButtons');
                    categoryButtonsContainer.innerHTML = '';
    
                    // Fetch products by category
                    for (const category of data.data) {
                        const categoryName = category.category;
                        const encodedCategoryName = encodeURIComponent(categoryName);
    
                        // Fetch products for each category
                        const productsResponse = await fetch(`http://localhost:5000/api/v1/product/ProductByCategory/${userId}?categoryName=${encodedCategoryName}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
    
                        const productsData = await productsResponse.json();
    
                        if (productsData.success) {
                            categories[categoryName] = productsData.data.map(product => ({
                                productId: product.product_id,
                                name: product.name,
                                price: product.price,
                                category: categoryName
                            }));
                            // Add category button
                            // categories[categoryName].forEach(item => {
                            //     console.log('Product ID:', item.productId);
                            // });
                            const button = document.createElement('button');
                            button.className = 'category-btn';
                            button.textContent = categoryName;
                            button.onclick = () => displayProducts(categoryName);
                            categoryButtonsContainer.appendChild(button);
                        } else {
                            console.error(`No products found for category: ${categoryName}`);
                        }
                    }
    
                    // Optionally, display the default or first category
                    if (data.data.length > 0) {
                        displayProducts(data.data[0].category);
                    }
                } else {
                    console.error('No categories found');
                }
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }
    
        // Function to display products for the selected category
        function displayProducts(categoryName) {
            const products = categories[categoryName]; // Get products for the selected category
    
            // Check if there are products for the selected category
            if (!products || products.length === 0) {
                console.error(`No products found for category: ${categoryName}`);
                return;
            }
    
            // Render products in the product-list div
            const productList = document.getElementById('product-list');
            productList.innerHTML = ''; // Clear previous products
    
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.classList.add('product-item');
                productDiv.innerHTML = `
                    <span>${product.name}</span>
                    <button class="product-button" data-name="${product.name}" data-id="${product.productId}" data-price="${product.price}">Add</button>
                `;
                productList.appendChild(productDiv);
            });
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            const productList = document.getElementById('product-list');
            const saleItems = document.getElementById('sale-items');
            const subTotalEl = document.getElementById('sub-total');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');
            const searchInput = document.getElementById('product-search');
            const categoryButtonsContainer = document.getElementById('categoryButtons');
            const customerIdInput = document.getElementById('vendor-id-input');
            const saveReceiptButton = document.getElementById('save-receipt-button');
            const total_discount= document.getElementById('totalDiscountEl');
    
            // Filter products by category and search term
            function filterProducts(category, searchTerm = '') {
                const filteredProducts = Object.entries(categories)
                    .flatMap(([cat, products]) =>
                        products.filter(p => (category === 'all' || p.category === category) &&
                            p.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                renderProducts(filteredProducts);
            }
    
            // Event listeners for category buttons
            categoryButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn')) {
                    const category = e.target.textContent;
                    const searchTerm = searchInput.value;
                    filterProducts(category, searchTerm);
                }
            });
    
            // Search functionality with category filtering
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                const selectedCategory = document.querySelector('.category-buttons .category-btn.active')?.textContent || 'all';
                filterProducts(selectedCategory, searchTerm);
            });
    
            // Render products dynamically
            function renderProducts(productArray) {
                productList.innerHTML = '';
                productArray.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('product-item');
                    productDiv.innerHTML = `
                        <span>${product.name}</span>
                        <button class="product-button" data-name="${product.name}" data-id="${product.productId}" data-price="${product.price}">Add</button>
                    `;
                    productList.appendChild(productDiv);
                });
            }
    
            // Add product to sale with quantity control
            productList.addEventListener('click', (e) => {
                if (e.target.classList.contains('product-button')) {
                    const productName = e.target.getAttribute('data-name');
                    const productId=e.target.getAttribute('data-id');
                   // console.log(productId);
                    const productPrice = parseFloat(e.target.getAttribute('data-price'));
                    const product = { name: productName,id:productId, price: productPrice };
                    addToSale(product);
                }
            });
    
            // Function to add product to the current sale
            function addToSale(product) {
                const existingItem = currentSale.find(item => item.name === product.name);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    currentSale.push({ ...product, quantity: 1 });
                }
                updateSaleUI();
            }
    
            // Function to update the sale UI and calculate totals
            function updateSaleUI() {
    saleItems.innerHTML = '';
    let subTotal = 0;
    let totalDiscount = 0;

    currentSale.forEach(item => {
        const listItem = document.createElement('li');
        
        // Display item details
        listItem.textContent = `${item.name} - $${item.price.toFixed(2)} x ${item.quantity}`;
        
        // Create a discount input field
        const discountInput = document.createElement('input');
        discountInput.type = 'number';
        discountInput.placeholder = 'Discount';
        discountInput.value = item.discount || 0; // Default discount value
        discountInput.style.marginLeft = '10px';
        discountInput.onchange = () => {
            const discountValue = parseFloat(discountInput.value) || 0;
            item.discount = discountValue; // Save discount for the item
            updateSaleUI(); // Recalculate totals and update UI
        };

        // Create a button to decrease quantity
        const decreaseButton = document.createElement('button');
        decreaseButton.textContent = '-';
        decreaseButton.onclick = () => {
            decreaseQuantity(item);
            updateSaleUI(); // Update UI after quantity change
        };

        // Append elements to the list item
        listItem.appendChild(discountInput);
        listItem.appendChild(decreaseButton);
        saleItems.appendChild(listItem);

        // Calculate discounted price for the item
        const effectivePrice = item.price - (item.discount || 0);
        const itemTotal = Math.max(0, effectivePrice) * item.quantity; // Ensure price is not negative
        subTotal += itemTotal;

        // Add discount for this item to total discount (only once, not per quantity)
        totalDiscount += item.discount || 0;
    });

    // Update subtotal, tax, total, and total discount
    subTotalEl.textContent = `${subTotal.toFixed(2)}`;
    const tax = subTotal * taxRate;
    taxEl.textContent = `${tax.toFixed(2)}`;
    totalEl.textContent = `${(subTotal + tax).toFixed(2)}`;
    totalDiscountEl.textContent = `${totalDiscount.toFixed(2)}`; // Update total discount field
}
    
            // Function to decrease quantity
            function decreaseQuantity(item) {
                const existingItem = currentSale.find(i => i.name === item.name);
                if (existingItem.quantity > 1) {
                    existingItem.quantity--;
                } else {
                    // If quantity is 1, remove the item
                    currentSale = currentSale.filter(i => i.name !== item.name);
                }
                updateSaleUI();
            }
            const signalSelect = document.getElementById('signal');
            // Save and print receipt functionality
            const paymentModal = document.getElementById('paymentModal');
            const overlay = document.getElementById('overlay');
            const confirmPaymentButton = document.getElementById('confirmPaymentButton');
            const closeModalButton = document.getElementById('closeModalButton');
            const chequeInput = document.getElementById('chequeInput');
            const exchangeInput = document.getElementById('exchangeInput');
            const chequeNumberInput = document.getElementById('chequeNumber');
            const exchangeDetailsInput = document.getElementById('exchangeDetails');

            let paymentDetails = ""; // This will store the payment details

            saveReceiptButton.addEventListener('click', () => {
        // Open the modal
                paymentModal.style.display = 'block';
                overlay.style.display = 'block';
            })

        document.querySelectorAll('input[name="paymentOption"]').forEach(option => {
        option.addEventListener('change', () => {
            if (option.value === "Cheque") {
                chequeInput.style.display = 'block';
                exchangeInput.style.display = 'none';
            } else if (option.value === "Exchange") {
                chequeInput.style.display = 'none';
                exchangeInput.style.display = 'block';
            } else {
                chequeInput.style.display = 'none';
                exchangeInput.style.display = 'none';
            }
        });
    });
            confirmPaymentButton.addEventListener('click', async () => {
        // Get selected payment option
                const selectedOption = document.querySelector('input[name="paymentOption"]:checked');

                if (!selectedOption) {
                    alert('Please select a payment option');
                    return;
                }

                if (selectedOption.value === "Cash") {
                    paymentDetails = "Cash";
                } else if (selectedOption.value === "Cheque") {
                    const chequeNumber = chequeNumberInput.value.trim();
                    if (!chequeNumber) {
                        alert('Please enter a cheque number');
                        return;
                    }
                    paymentDetails = chequeNumber;
                } else if (selectedOption.value === "Exchange") {
                    const exchangeDetails = exchangeDetailsInput.value.trim();
                    if (!exchangeDetails) {
                        alert('Please enter exchange details');
                        return;
                    }
                    // paymentDetails = `Exchange: ${exchangeDetails}`;
                    paymentDetails=exchangeDetails;
                }

                // Close the modal
                paymentModal.style.display = 'none';
                overlay.style.display = 'none';

                // Prepare receipt data
                const receiptData = {
                    vendor_id: customerIdInput.value, // Assuming this is the correct customer ID field
                    purchase_date: new Date().toISOString().slice(0, 19).replace('T', ' '), // Current date in the required format
                    total_price: parseFloat(totalEl.textContent.replace('$', '')), // Remove the $ and convert to number
                    payment_status: signalSelect.value, // Assuming this is the field for payment status
                    user_id: uid, // Assuming user_id is 1 for now (this can be dynamic if needed)
                     // Add payment details here
                    items: currentSale.map(item => ({
                        product_id: item.id, // Function to map product name to product ID
                        price: item.price,
                        quantity: item.quantity
                    })),
                    payment_details: paymentDetails,
                    discount: parseFloat(total_discount.textContent.replace('$', ''))
                };

                console.log('Formatted Receipt Data:', receiptData);
                // console.log(total_discount);
                try {
                    const response = await fetch('http://localhost:5000/api/v1/vendor/addSupply ', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(receiptData),
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to save receipt: ${response.statusText}`);
                    }

                    const result = await response.json();
                    alert('Receipt saved successfully!');
                    console.log('API Response:', result);
                } catch (error) {
                    console.error('Error saving receipt:', error);
                    alert('Failed to save receipt. Please try again.');
                }

                location.reload();

                
            });

        closeModalButton.addEventListener('click', () => {
            paymentModal.style.display = 'none';
            overlay.style.display = 'none';
        });
    
            // Load categories for user id
            loadCategories(getUserIdFromToken());
    
        });
    
        function logout() {
            // Implement logout functionality
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
        document.addEventListener("DOMContentLoaded", () => {
    const openModalBtn = document.getElementById("open-modal-btn");
    const modal = document.getElementById("vendor-modal");
    const closeModalBtn = document.querySelector(".close-btn");
    const vendorList = document.getElementById("vendor-list");
    const vendorIdInput = document.getElementById("vendor-id-input");
    const userId = 'yourUserId'; // Replace with actual user ID

    // Open modal on button click
    openModalBtn.addEventListener("click", async () => {
        modal.style.display = "block";
        await fetchVendors();
    });

    // Close modal on 'X' button click
    closeModalBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    // Close modal when clicking outside modal content
    window.addEventListener("click", (event) => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });

    // Fetch vendors and populate list
    async function fetchVendors() {
        try {
            const apiUrl = `http://localhost:5000/api/v1/vendor/getVendors/${uid}`;
            const response = await fetch(apiUrl);
            const data = await response.json();
            console.log(data);
            if (data.success) {
                vendorList.innerHTML = ""; // Clear previous list items
                data.data.forEach(vendor => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${vendor.name} (ID: ${vendor.vendor_id})`;
                    listItem.dataset.vendorId = vendor.vendor_id;

                    // Set vendor ID on list item click
                    listItem.addEventListener("click", () => {
                        vendorIdInput.value = listItem.dataset.vendorId;
                        modal.style.display = "none"; // Close the modal
                    });

                    vendorList.appendChild(listItem);
                });
            } else {
                console.error(data.message);
                vendorList.innerHTML = "<li>No vendors available.</li>";
            }
        } catch (error) {
            console.error("Error fetching vendor data:", error);
            vendorList.innerHTML = "<li>Error loading vendors.</li>";
        }
    }
});

   


    </script>
    
    

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz4fnFO9gybktF+z6kbuTqVDn0mgF1vj4irZyw+PQ5mHkA1Utbm24D+R1e" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-oBqDVmMz4fnFO9gybktF+z6kbuTqVDn0mgF1vj4irZyw+PQ5mHkA1Utbm24D+R1e" crossorigin="anonymous"></script>
</body>
</html>
